document.addEventListener("DOMContentLoaded",function(){document.querySelector("#storyForm")&&initEdit()});function initEdit(){resizedImage=null,mode=document.querySelector("#storyForm").dataset.mode,fileChange(document.getElementById("imageFile")),$("#imageFile").on("change",function(){fileChange(this)})}function fileChange(t){var e=t.files[0];e?($(".file-name").html(e.name),$(".file").addClass("has-name"),$("#imageField .file-name").removeClass("is-hidden"),e.type!="image/jpeg"&&e.type!="image/png"?($("#fileError .message-body").html("Format de fichier non pris en charge.<br>Les formats acceptés sont : JPG et PNG."),$("#fileError").removeClass("is-hidden")):e.size<8e5?(resizedImage=e,showPreview()):resizeImage(e,function(e){resizedImage=e,showPreview()})):mode=="new"&&clearFileInputStyle()}function showPreview(){$("#fileError").addClass("is-hidden"),$("#preview img").attr("src",URL.createObjectURL(resizedImage)),$("#preview").removeClass("is-hidden")}function uploadStory(){let e=document.getElementById("storyForm");if(e.checkValidity())if($("#storyForm .message.is-danger").not(".is-hidden").length>0)animateCSS("#fileError","headShake");else{setSubmitButton("sending");let e=new FormData;if(e.set("text",document.querySelector("#text").value),resizedImage){let t=new FormData;t.set("folder","humans-of-grenoble"),fetchCloudinarySign(t).then(function(n){t.set("api_key",n.api_key),t.set("timestamp",n.timestamp),t.set("signature",n.signature),t.set("file",resizedImage),cloudinaryUpload(t).then(function(t){e.set("photoUrl",t.secure_url),e.set("photoPublicId",t.public_id),setStory(e).then(function(){setSubmitButton("send"),mode=="new"&&(clearForm(),notify("success","Story publiée avec succès.")),mode=="edit"&&(clearProgress(),notify("success","Story éditée avec succès."))}).catch(function(e){setSubmitButton("send"),notify("failure",e)})}).catch(function(e){setSubmitButton("send"),notify("failure",e)})}).catch(function(e){setSubmitButton("send"),notify("failure",e)})}else setStory(e).then(function(){clearProgress(),setSubmitButton("send"),notify("success","Story éditée avec succès.")}).catch(function(e){setSubmitButton("send"),notify("failure",e)})}else document.querySelector("#fakeSubmit").click()}function cloudinaryUpload(e){return new Promise((s,n)=>{var t=new XMLHttpRequest;t.responseType="json",t.upload.addEventListener("progress",function(e){var t=Math.round(e.loaded/e.total*100);$("progress").val(t),$("progress").html(t+"%")}),t.addEventListener("load",function(e){e.target.status==200?s(e.target.response):n("Le serveur a répondu par une erreur "+e.target.status+".")}),t.addEventListener("error",function(){n("Le serveur est injoignable.")}),t.addEventListener("abort",function(){n("Requête annulée.")}),$("progress").removeClass("is-hidden"),t.open("POST","https://api.cloudinary.com/v1_1/dehn7bofz/image/upload"),t.send(e)})}function fetchCloudinarySign(e){return new Promise((s,n)=>{var t=new XMLHttpRequest;t.responseType="json",t.addEventListener("load",function(e){e.target.status==200?s(e.target.response):n("Le serveur a répondu par une erreur "+e.target.status+".")}),t.addEventListener("error",function(){n("Le serveur est injoignable.")}),t.addEventListener("abort",function(){n("Requête annulée.")}),t.open("POST","/admin/cloudinary"),t.send(e)})}function setStory(e){return new Promise((s,n)=>{var t=new XMLHttpRequest;t.addEventListener("load",function(e){e.target.status==200?s(e.target.responseText):n("Le serveur a répondu par une erreur "+e.target.status+".")}),t.addEventListener("error",function(){n("Le serveur est injoignable.")}),t.addEventListener("abort",function(){n("Requête annulée.")}),t.open("POST",window.location.href),t.send(e)})}function clearForm(){document.getElementById("storyForm").reset(),clearFileInputStyle(),clearProgress()}function clearFileInputStyle(){$("#preview, #imageField .file-name").addClass("is-hidden"),$("#imageField .file").removeClass("has-name"),$("#imageField .file-name").html("")}function clearProgress(){$("progress").addClass("is-hidden"),$("progress").val(0),$("progress").html("")}function resizeImage(t,s){let e=document.createElement("canvas"),o=e.getContext("2d");var n=new Image;n.onload=function(){var r=this.width/this.height,i,a;this.height<this.width?(i=1500,a=1500*r):(a=1500,i=1500/r),e.width=a,e.height=i,o.drawImage(n,0,0,a,i),e.toBlob(function(e){var n=t.name.substring(0,t.name.lastIndexOf("."))+".jpg",o=new File([e],n,{type:"image/jpeg"});s(o)},"image/jpeg",.7)},n.src=URL.createObjectURL(t)}function deleteStory(n){let t=$(n.target).closest(".box").attr("data-id"),e="[data-id='"+t+"']";var s=$(e+" img").prop("outerHTML");modalConfirm("Supprimer cette story ?",s,"Supprimer",function(){let n=new XMLHttpRequest;n.addEventListener("load",function(t){t.target.status==200?t.target.responseText.trim()=="OK"?animateCSS(e,"zoomOut").then(t=>{$(e).remove()}):modAlert("failure","Le service est buggé. Contactez l'administrateur."):modAlert("failure","Le serveur a répondu par une erreur "+t.target.status+".")}),n.addEventListener("error",function(){modAlert("failure","Le serveur est injoignable.")}),n.addEventListener("abort",function(){modAlert("failure","Requête annulée.")}),n.open("DELETE","/admin/edit/"+t),n.send()})}function updatePassword(){document.querySelector(".notify").innerHtml="";let e=document.querySelector("#newPassForm");if(e.checkValidity()){let s=new FormData(e);var t=s.get("password"),n=s.get("password-confirm");if(t!=n)notify("failure","Le mot de passe et sa confirmation sont différents.");else{setSubmitButton("sending");let t=new XMLHttpRequest;t.addEventListener("load",function(t){t.target.status==200?t.target.responseText.trim()=="OK"?(e.reset(),notify("success","Le mot de passe a été mis à jour.")):notify("failure","Une erreur inattendue est survenue. Contactez l'administrateur."):notify("failure","Le serveur a répondu par une erreur "+t.target.status+".")}),t.addEventListener("error",function(){notify("failure","Le serveur est injoignable.")}),t.addEventListener("loadend",function(){setSubmitButton("send")}),t.addEventListener("abort",function(){setSubmitButton("send"),notify("failure","Requête annulée.")}),t.open("POST","/admin/new-password"),t.send(s)}}else document.querySelector("#fakeSubmit").click()}function setSubmitButton(e){e=="send"&&(document.querySelector("#sendButton").classList.remove("is-hidden"),document.querySelector("#sendingButton").classList.add("is-hidden")),e=="sending"&&(document.querySelector("#sendButton").classList.add("is-hidden"),document.querySelector("#sendingButton").classList.remove("is-hidden"))}function logout(){let e=new XMLHttpRequest;e.addEventListener("load",function(e){e.target.status==200?e.target.responseText.trim()=="OK"?window.location.href="/admin/login":modAlert("failure","Une erreur inattendue est survenue. Contactez l'administrateur."):modAlert("failure","Le serveur a répondu par une erreur "+e.target.status+".")}),e.addEventListener("error",function(){modAlert("failure","Le serveur est injoignable.")}),e.addEventListener("abort",function(){modAlert("failure","Requête annulée.")}),e.open("DELETE","/admin/login"),e.send()}function notify(n,s){var e=document.createElement("div"),t,o;e.classList.add("notification"),n=="success"&&e.classList.add("is-success"),n=="failure"&&e.classList.add("is-danger"),t=document.createElement("button"),t.setAttribute("type","button"),t.classList.add("delete"),t.addEventListener("click",function(){let e=$(this).closest(".notification");animateCSS(e,"zoomOut").then(function(){e.remove()})}),o=document.createTextNode(s),e.appendChild(t),e.appendChild(o),document.querySelector(".notify").appendChild(e),animateCSS(e,"slideInUp")}function sendMail(){let e=document.getElementById("contactForm");if(e.checkValidity()){setSubmitButton("sending");let n=new FormData(e),t=new XMLHttpRequest;t.addEventListener("load",function(t){t.target.status==200?t.target.responseText.trim()=="OK"?(e.reset(),setSubmitButton("send"),notify("success","Votre message a bien été envoyé. Merci !")):(setSubmitButton("send"),notify("failure","Une erreur inattendue est survenue. Contactez l'administrateur.")):(setSubmitButton("send"),notify("failure","Le serveur a répondu par une erreur "+t.target.status+"."))}),t.addEventListener("error",function(){setSubmitButton("send"),notify("failure","Le serveur est injoignable.")}),t.addEventListener("abort",function(){setSubmitButton("send"),notify("failure","Requête annulée.")}),t.open("POST","/contact"),t.send(n)}else document.querySelector("#fakeSubmit").click()}function preventEnterKey(e){e.keyCode==13&&document.activeElement.tagName!="TEXTAREA"&&(e.preventDefault(),document.querySelector("#sendButton").click())}