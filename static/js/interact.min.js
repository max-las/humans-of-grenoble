document.addEventListener("DOMContentLoaded",function(){document.querySelector("#storyForm")&&initEdit()});function initEdit(){resizedImage=null,mode=document.querySelector("#storyForm").dataset.mode,fileChange(document.getElementById("imageFile")),$("#imageFile").on("change",function(){fileChange(this)})}function fileChange(b){var a=b.files[0];a?($(".file-name").html(a.name),$(".file").addClass("has-name"),$("#imageField .file-name").removeClass("is-hidden"),a.type!="image/jpeg"&&a.type!="image/png"?($("#fileError .message-body").html("Format de fichier non pris en charge.<br>Les formats acceptés sont : JPG et PNG."),$("#fileError").removeClass("is-hidden")):a.size<8e5?(resizedImage=a,showPreview()):resizeImage(a,function(a){resizedImage=a,showPreview()})):mode=="new"&&clearFileInputStyle()}function showPreview(){$("#fileError").addClass("is-hidden"),$("#preview img").attr("src",URL.createObjectURL(resizedImage)),$("#preview").removeClass("is-hidden")}function uploadStory(b){let a=document.getElementById("storyForm");if(a.checkValidity())if($("#storyForm .message.is-danger").not(".is-hidden").length>0)animateCSS("#fileError","headShake");else{setSubmitButton("sending");let a=new FormData;if(a.set("text",document.querySelector("#text").value),resizedImage){let b=new FormData;b.set("folder","humans-of-grenoble"),fetchCloudinarySign(b).then(function(c){b.set("api_key",c.api_key),b.set("timestamp",c.timestamp),b.set("signature",c.signature),b.set("file",resizedImage),cloudinaryUpload(b).then(function(b){a.set("photoUrl",b.secure_url),a.set("photoPublicId",b.public_id),setStory(a).then(function(a){setSubmitButton("send"),mode=="new"&&(clearForm(),notify("success","Story publiée avec succès.")),mode=="edit"&&(clearProgress(),notify("success","Story éditée avec succès."))}).catch(function(a){setSubmitButton("send"),notify("failure",a)})}).catch(function(a){setSubmitButton("send"),notify("failure",a)})}).catch(function(a){setSubmitButton("send"),notify("failure",a)})}else setStory(a).then(function(a){clearProgress(),notify("success","Story éditée avec succès.")}).catch(function(a){setSubmitButton("send"),notify("failure",a)})}else document.querySelector("#fakeSubmit").click()}function cloudinaryUpload(a){return new Promise((d,c)=>{var b=new XMLHttpRequest;b.responseType="json",b.upload.addEventListener("progress",function(a){var b=Math.round(a.loaded/a.total*100);$("progress").val(b),$("progress").html(b+"%")}),b.addEventListener("load",function(a){a.target.status==200?d(a.target.response):c("Le serveur a répondu par une erreur "+a.target.status+".")}),b.addEventListener("error",function(a){c("Le serveur est injoignable.")}),b.addEventListener("abort",function(a){c("Requête annulée.")}),$("progress").removeClass("is-hidden"),b.open("POST","https://api.cloudinary.com/v1_1/dehn7bofz/image/upload"),b.send(a)})}function fetchCloudinarySign(a){return new Promise((d,c)=>{var b=new XMLHttpRequest;b.responseType="json",b.addEventListener("load",function(a){a.target.status==200?d(a.target.response):c("Le serveur a répondu par une erreur "+a.target.status+".")}),b.addEventListener("error",function(a){c("Le serveur est injoignable.")}),b.addEventListener("abort",function(a){c("Requête annulée.")}),b.open("POST","/admin/cloudinary"),b.send(a)})}function setStory(a){return new Promise((d,c)=>{var b=new XMLHttpRequest;b.addEventListener("load",function(a){a.target.status==200?d(a.target.responseText):c("Le serveur a répondu par une erreur "+a.target.status+".")}),b.addEventListener("error",function(a){c("Le serveur est injoignable.")}),b.addEventListener("abort",function(a){c("Requête annulée.")}),b.open("POST",window.location.href),b.send(a)})}function clearForm(){document.getElementById("storyForm").reset(),clearFileInputStyle(),clearProgress()}function clearFileInputStyle(){$("#preview, #imageField .file-name").addClass("is-hidden"),$("#imageField .file").removeClass("has-name"),$("#imageField .file-name").html("")}function clearProgress(){$("progress").addClass("is-hidden"),$("progress").val(0),$("progress").html("")}function resizeImage(b,d){let a=document.createElement("canvas"),e=a.getContext("2d");var c=new Image;c.onload=function(){var h=this.width/this.height,f,g;this.height<this.width?(f=1500,g=1500*h):(g=1500,f=1500/h),a.width=g,a.height=f,e.drawImage(c,0,0,g,f),a.toBlob(function(a){var c=b.name.substring(0,b.name.lastIndexOf("."))+".jpg",e=new File([a],c,{type:"image/jpeg"});d(e)},"image/jpeg",.7)},c.src=URL.createObjectURL(b)}function deleteStory(c){let b=$(c.target).closest(".box").attr("data-id"),a="[data-id='"+b+"']";var d=$(a+" img").prop("outerHTML");modalConfirm("Supprimer cette story ?",d,"Supprimer",function(){let c=new XMLHttpRequest;c.addEventListener("load",function(b){b.target.status==200?b.target.responseText.trim()=="OK"?animateCSS(a,"zoomOut").then(b=>{$(a).remove()}):modAlert("failure","Le service est buggé. Contactez l'administrateur."):modAlert("failure","Le serveur a répondu par une erreur "+b.target.status+".")}),c.addEventListener("error",function(a){modAlert("failure","Le serveur est injoignable.")}),c.addEventListener("abort",function(a){modAlert("failure","Requête annulée.")}),c.open("DELETE","/admin/edit/"+b),c.send()})}function updatePassword(d){var b,c;document.querySelector(".notify").innerHtml="";let a=document.querySelector("#newPassForm");if(a.checkValidity()){let d=new FormData(a);if(b=d.get("password"),c=d.get("password-confirm"),b!=c)notify("failure","Le mot de passe et sa confirmation sont différents.");else{setSubmitButton("sending");let b=new XMLHttpRequest;b.addEventListener("load",function(b){b.target.status==200?b.target.responseText.trim()=="OK"?(a.reset(),notify("success","Le mot de passe a été mis à jour.")):notify("failure","Une erreur inattendue est survenue. Contactez l'administrateur."):notify("failure","Le serveur a répondu par une erreur "+b.target.status+".")}),b.addEventListener("error",function(a){notify("failure","Le serveur est injoignable.")}),b.addEventListener("loadend",function(a){setSubmitButton("send")}),b.addEventListener("abort",function(a){setSubmitButton("send"),notify("failure","Requête annulée.")}),b.open("POST","/admin/new-password"),b.send(d)}}else document.querySelector("#fakeSubmit").click()}function setSubmitButton(a){a=="send"&&(document.querySelector("#sendButton").classList.remove("is-hidden"),document.querySelector("#sendingButton").classList.add("is-hidden")),a=="sending"&&(document.querySelector("#sendButton").classList.add("is-hidden"),document.querySelector("#sendingButton").classList.remove("is-hidden"))}function logout(){let a=new XMLHttpRequest;a.addEventListener("load",function(a){a.target.status==200?a.target.responseText.trim()=="OK"?window.location.href="/admin/login":modAlert("failure","Une erreur inattendue est survenue. Contactez l'administrateur."):modAlert("failure","Le serveur a répondu par une erreur "+a.target.status+".")}),a.addEventListener("error",function(a){modAlert("failure","Le serveur est injoignable.")}),a.addEventListener("abort",function(a){modAlert("failure","Requête annulée.")}),a.open("DELETE","/admin/login"),a.send()}function notify(c,d){var a=document.createElement("div"),b,e;a.classList.add("notification"),c=="success"&&a.classList.add("is-success"),c=="failure"&&a.classList.add("is-danger"),b=document.createElement("button"),b.setAttribute("type","button"),b.classList.add("delete"),b.addEventListener("click",function(){let a=$(this).closest(".notification");animateCSS(a,"zoomOut").then(function(){a.remove()})}),e=document.createTextNode(d),a.appendChild(b),a.appendChild(e),document.querySelector(".notify").appendChild(a),animateCSS(a,"slideInUp")}function sendMail(b){let a=document.getElementById("contactForm");if(a.checkValidity()){setSubmitButton("sending");let c=new FormData(a),b=new XMLHttpRequest;b.addEventListener("load",function(b){b.target.status==200?b.target.responseText.trim()=="OK"?(a.reset(),setSubmitButton("send"),notify("success","Votre message a bien été envoyé. Merci !")):(setSubmitButton("send"),notify("failure","Une erreur inattendue est survenue. Contactez l'administrateur.")):(setSubmitButton("send"),notify("failure","Le serveur a répondu par une erreur "+b.target.status+"."))}),b.addEventListener("error",function(a){setSubmitButton("send"),notify("failure","Le serveur est injoignable.")}),b.addEventListener("abort",function(a){setSubmitButton("send"),notify("failure","Requête annulée.")}),b.open("POST","/contact"),b.send(c)}else document.querySelector("#fakeSubmit").click()}function preventEnterKey(a){a.keyCode==13&&document.activeElement.tagName!="TEXTAREA"&&(a.preventDefault(),document.querySelector("#sendButton").click())}